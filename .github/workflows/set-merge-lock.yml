name: clear-merge-lock

on:
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:

    - name: Create Pending Merge Lock Check
      id: create_merge_lock
      uses: actions/github-script@v7
      with:
        # Use PR head SHA, otherwise commit SHA
        script: |
          const checkName = 'merge-lock-critical-workflow';
          console.log(`Creating pending check run: ${checkName}`);
          const response = await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: checkName,
            head_sha: context.payload.pull_request?.head.sha || context.sha,
            status: 'in_progress',
            output: {
              title: 'Critical Workflow Running',
              summary: 'Merges are temporarily blocked while this critical workflow runs.'
            }
          });
          console.log(`Check run created with ID: ${response.data.id}`);
          return response.data.id
        # Needs checks write perm
      env:
        GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_TOKEN }}
