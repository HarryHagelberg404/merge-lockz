name: clear-merge-lock

on:
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:

    - name: Update Merge Lock Check to Success
      uses: actions/github-script@v7
      # Use always() so runs if previous steps fail and only run if lock was created
      if: always()
      with:
        # Even if the workflow failed, the *lock* is released.
        # Mark as success to unblock the merge check.
        script: |
          const checkRunId = ${{ steps.create_merge_lock.outputs.result }}
          const conclusion = '${{ job.status }}' === 'success' ? 'success' : 'neutral'
          const checkName = 'merge-lock-critical-workflow'

          if (!checkRunId) {
            console.log('Could not find check run ID. Skipping update.')
            return
          }

          console.log(`Updating check run ID: ${checkRunId} to conclusion: ${conclusion}`)

          await github.rest.checks.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            check_run_id: checkRunId,
            status: 'completed',
            conclusion: 'success',
            output: {
              title: 'Critical Workflow Finished',
              summary: `Workflow completed with status: ${{ job.status }}. Merge lock released.`
            }
          })
          console.log('Check run updated.')
      env:
        GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_TOKEN }}

